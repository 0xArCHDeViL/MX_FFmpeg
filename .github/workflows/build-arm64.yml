name: Build ARM64-V8A

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  NDK_VERSION: '25.2.9519653'

jobs:
  # ============================================
  # MAIN BUILD - Build All Libraries Together
  # ============================================
  build-all-arm64:
    name: "Build All (arm64-v8a)"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c
          add-to-path: true
      
      - name: Set NDK Environment Variable
        run: |
          echo "NDK=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV
      
      - name: Build OpenSSL (arm64)
        if: steps.cache-openssl.outputs.cache-hit != 'true'
        working-directory: ffmpeg/jni
        run: |
          chmod +x build-openssl.sh
          ./build-openssl.sh arm64

      - name: Copy OpenSSL to Source Dir (Cache Fix)
        working-directory: ffmpeg/jni
        run: |
          # Ensure libssl.a and libcrypto.a are in openssl-1.0.2s/ where Android.mk expects them
          cp openssl-1.0.2s/libssl.a openssl-1.0.2s/libcrypto.a . || true
          mkdir -p libs/arm64-v8a
          cp openssl-1.0.2s/libssl.a libs/arm64-v8a/
          cp openssl-1.0.2s/libcrypto.a libs/arm64-v8a/
      
      - name: Install Meson and Ninja
        run: |
          python3 -m pip install --upgrade pip
          pip3 install meson ninja
      
      - name: Build dav1d (arm64)
        working-directory: ffmpeg/jni
        run: |
          chmod +x build-libdav1d.sh
          ./build-libdav1d.sh arm64
      
      - name: Build libsmb2 (arm64)
        run: |
          cd ffmpeg/jni
          chmod +x build-libsmb2.sh
          ./build-libsmb2.sh arm64
        
      - name: Build libmp3lame (arm64)
        working-directory: ffmpeg/jni
        run: |
          $NDK/ndk-build \
            -j$(nproc) \
            APP_ABI=arm64-v8a \
            APP_PLATFORM=android-21 \
            APP_BUILD_SCRIPT=libmp3lame.mk \
            NDK_APP_DST_DIR=libs/arm64-v8a
      
      - name: Build libmxutil (arm64)
        working-directory: ffmpeg/jni
        run: |
          $NDK/ndk-build \
            -j$(nproc) \
            APP_ABI=arm64-v8a \
            APP_PLATFORM=android-21 \
            APP_BUILD_SCRIPT=a-mxutil.mk \
            ARCH=armv8-a \
            VFP=neon \
            NDK_APP_DST_DIR=libs/arm64-v8a \
            TARGET_ARCH=arm64
      
      - name: Build FFmpeg with all libraries (arm64)
        working-directory: ffmpeg/jni
        run: |
          chmod +x build-ffmpeg.sh
          ./build-ffmpeg.sh arm64
      
      - name: Upload All Libraries
        uses: actions/upload-artifact@v4
        with:
          name: all-libraries-arm64-v8a
          path: |
            ffmpeg/jni/libs/arm64-v8a/*.so
          retention-days: 7


